<!-- cropperCSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.9/cropper.min.css" integrity="sha512-w+u2vZqMNUVngx+0GVZYM21Qm093kAexjueWOv9e9nIeYJb1iEfiHC7Y+VvmP/tviQyA5IR32mwN/5hTEJx6Ng==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- cropperJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.9/cropper.min.js" integrity="sha512-9pGiHYK23sqK5Zm0oF45sNBAX/JqbZEP7bSDHyt+nT3GddF+VFIcYNqREt0GDpmFVZI3LZ17Zu9nMMc9iktkCw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- Icons CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<div>
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Teams</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addTeamModal">Create new team</button>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-sm" id="teamList"></table>
    </div>
</div>

 <!-- Modal para registrar nuevo equipo -->
<div class="modal fade" id="addTeamModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add new team</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="frmTeam">
                    <div class="mb-3">
                        <label for="inputName" class="form-label">Team Name</label>
                        <input type="text" name="inputName" class="form-control" id="inputName">              
                    </div>
                    <div class="mb-3">
                        <label for="imageteam" class="form-label">Team image</label>
                        <img class="rounded w-100 d-none img-fluid" id="imgPreview" src="#" alt="Preview" data-btnid="btnDelete" data-foto="1">
                        <input class="form-control form-control-sm" id="imageteam" name="imageteam" type="file" accept="image/*">
                    </div>
                    <button type="button" class="btn btn-primary" id="btnRegisterTeam">Submit</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar las imagenes -->
<div class="modal fade" id="modalCrop" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabel">Edit / Crop the photo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="img-container mb-3" style="max-height: 500px">
                    <img id="image" src="#">
                </div>
                <div id="cropper-buttons">
                    <div class="docs-buttons">
                        <div class="btn-group">
                            <button type="button" class="btn btn-success mb-3" data-method="setDragMode" data-option="move" title="Move">
                                <span data-toggle="tooltip" title="Shift image">
                                    <span class="fa fa-arrows-alt"></span>
                                </span>
                            </button>
                            <button type="button" class="btn btn-success mb-3" data-method="setDragMode" data-option="crop" title="Cut">
                                <span data-toggle="tooltip" title="Cut">
                                    <span class="fa fa-crop-alt"></span>
                                </span>
                            </button>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-success mb-3" data-method="zoom" data-option="0.1" title="Zoom In">
                                <span data-toggle="tooltip" title="Zoom(+0.1)">
                                    <span class="fa fa-search-plus"></span>
                                </span>
                            </button>
                            <button type="button" class="btn btn-success mb-3" data-method="zoom" data-option="-0.1" title="Zoom Out">
                                <span data-toggle="tooltip" title="Zoom(-0.1)">
                                    <span class="fa fa-search-minus"></span>
                                </span>
                            </button>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-success mb-3" data-method="move" data-option="-10" data-second-option="0" title="Move left">
                                <span data-toggle="tooltip" title="Move (-10, 0)">
                                    <span class="fa fa-arrow-left"></span>
                                </span>
                            </button>
                            <button type="button" class="btn btn-success mb-3" data-method="move" data-option="10" data-second-option="0" title="Move right">
                                <span data-toggle="tooltip" title="Move (10, 0)">
                                    <span class="fa fa-arrow-right"></span>
                                </span>
                            </button>
                            <button type="button" class="btn btn-success mb-3" data-method="move" data-option="0" data-second-option="-10" title="Move up">
                                <span data-toggle="tooltip" title="Move (0, -10)">
                                    <span class="fa fa-arrow-up"></span>
                                </span>
                            </button>
                            <button type="button" class="btn btn-success mb-3" data-method="move" data-option="0" data-second-option="10" title="Move down">
                                <span data-toggle="tooltip" title="Move (0, 10)">
                                    <span class="fa fa-arrow-down"></span>
                                </span>
                            </button>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-success mb-3" data-method="rotate" data-option="-45" title="Rotate left">
                                <span data-toggle="tooltip" title="Rotate (-45)">
                                    <span class="fa fa-undo-alt"></span>
                                </span>
                            </button>
                            <button type="button" class="btn btn-success mb-3" data-method="rotate" data-option="45" title="Rotate right">
                                <span data-toggle="tooltip" title="Rotate (45)">
                                    <span class="fa fa-redo-alt"></span>
                                </span>
                            </button>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-success mb-3" data-method="scaleX" data-option="-1" title="Flip horizontal">
                                <span data-toggle="tooltip" title="Scale X (-1)">
                                    <span class="fa fa-arrows-alt-h"></span>
                                </span>
                            </button>
                            <button type="button" class="btn btn-success mb-3" data-method="scaleY" data-option="-1" title="Turn vertical">
                                <span data-toggle="tooltip" title="Scale Y (-1)">
                                    <span class="fa fa-arrows-alt-v"></span>
                                </span>
                            </button>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-success mb-3" data-method="disable" title="Deactivate">
                                <span data-toggle="tooltip" title="To protect">
                                    <span class="fa fa-lock"></span>
                                </span>
                            </button>
                            <button type="button" class="btn btn-success mb-3" data-method="enable" title="Activate">
                                <span data-toggle="tooltip" title="Edit mode">
                                    <span class="fa fa-unlock"></span>
                                </span>
                            </button>
                            <button type="button" class="btn btn-success mb-3" data-method="reset" title="Restore">
                                <span data-toggle="tooltip" title="Restore">
                                    <span class="fa fa-sync-alt"></span>
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="cropImage">Apply</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    var teamPhoto   = null;

    $(document).ready(function(){
        // Registrar nuevo equipo
        $("#btnRegisterTeam").on("click", fnRegisterTeam);

        // Controlar tipo de objeto que intentan subir
        $('input[type="file"]').on('change', function(){
            let ext = $( this ).val().split('.').pop();

            if ($( this ).val() != ''){
                if($.inArray(ext, ["jpg", "jpeg", "png", "bmp", "raw", "tiff"]) != -1){
                    if($(this)[0].files[0].size > 1048576){
                        $( this ).val('');
                        alert('Your selected file is larger than 1MB');
                    }
                }else{
                    $( this ).val('');
                    alert(`${ext} files not allowed, only images`);
                }
            }
        });

        // Image Cropper
        let picture = null,
        image       = $("#image")[0],
        inputFile   = $("#imageteam")[0],
        $modal      = $('#modalCrop'),
        cropper     = null;

        inputFile.addEventListener("change", function(e){
            picture   = $("#imgPreview");
            let files = e.target.files,
                done  = function (url){
                    inputFile.value = "";
                    image.src = url;
                    $modal.modal('show');
                },
                reader,
                file,
                url;

            if (files && files.length > 0){
                file = files[0];

                if (URL){
                    done(URL.createObjectURL(file));
                }
                else if (FileReader){
                    reader = new FileReader();
                    reader.onload = function(e){
                        done(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
            }
        });

        $modal.on('shown.bs.modal', function(){
            let URL         = window.URL || window.webkitURL,
                container   = document.querySelector('.img-container'),
                download    = document.getElementById('download');
                actions     = document.getElementById('cropper-buttons'),
                minCroppedWidth = 900;
                minCroppedHeight = 400;
                maxCroppedWidth = 900;
                maxCroppedHeight = 400,
                options     = {
                    // aspectRatio: 1,
                    viewMode: 3,
                    data: {
                        width: (minCroppedWidth + maxCroppedWidth) / 2,
                        height: (minCroppedHeight + maxCroppedHeight) / 2,
                    },
                    crop: function (event) {
                        var width = event.detail.width;
                        var height = event.detail.height;

                        if (
                            width < minCroppedWidth
                            || height < minCroppedHeight
                            || width > maxCroppedWidth
                            || height > maxCroppedHeight
                        ) {
                            cropper.setData({
                            width: Math.max(minCroppedWidth, Math.min(maxCroppedWidth, width)),
                            height: Math.max(minCroppedHeight, Math.min(maxCroppedHeight, height)),
                            });
                        }
                        // data.textContent = JSON.stringify(cropper.getData(true));
                    }
                };

            cropper = new Cropper(image, options);

            // Metodos
            actions.querySelector('.docs-buttons').onclick = function (event){
                let e       = event || window.event,
                    target  = e.target || e.srcElement,
                    cropped = null,
                    result  = null,
                    input   = null,
                    data    = null;

                if (!cropper)
                    return;

                while (target !== this) {
                    if (target.getAttribute('data-method'))
                        break;

                    target = target.parentNode;
                }

                if(target === this || target.disabled || target.className.indexOf('disabled') > -1)
                    return;

                data = {
                    method:         target.getAttribute('data-method'),
                    target:         target.getAttribute('data-target'),
                    option:         target.getAttribute('data-option') || undefined,
                    secondOption:   target.getAttribute('data-second-option') || undefined
                };

                cropped = cropper.cropped;

                if(data.method){
                    if (typeof data.target !== 'undefined') {
                        input = document.querySelector(data.target);
                        if (!target.hasAttribute('data-option') && data.target && input) {
                            try {
                                data.option = JSON.parse(input.value);
                            } catch (e) {
                                console.log("");
                            }
                        }
                    }

                    switch (data.method) {
                        case 'rotate':
                            if (cropped && options.viewMode > 0)
                                cropper.clear();

                            break;
                        case 'getCroppedCanvas':
                            try {
                                data.option = JSON.parse(data.option);
                            } catch (e) {
                                console.log("");
                            }

                            if (uploadedImageType === 'image/jpeg') {
                                if (!data.option)
                                    data.option = {};

                                data.option.fillColor = '#fff';
                            }

                            break;
                    }

                    result = cropper[data.method](data.option, data.secondOption);

                    switch (data.method) {
                        case 'rotate':
                            if (cropped && options.viewMode > 0)
                                cropper.crop();

                            break;
                        case 'scaleX':
                        case 'scaleY':
                            target.setAttribute('data-option', -data.option);
                            break;
                        case 'getCroppedCanvas':
                            if (result) {
                                $('#getCroppedCanvasModal').modal().find('.modal-body').html(result);

                                if (!download.disabled) {
                                    download.download = uploadedImageName;
                                    download.href = result.toDataURL(uploadedImageType);
                                }
                            }

                            break;
                        case 'destroy':
                            cropper = null;
                            if (uploadedImageURL) {
                                URL.revokeObjectURL(uploadedImageURL);
                                uploadedImageURL = '';
                                image.src = originalImageURL;
                            }

                            break;
                    }

                    if (typeof result === 'object' && result !== cropper && input) {
                        try {
                            input.value = JSON.stringify(result);
                        } catch (e) {
                            console.log("");
                        }
                    }
                }
            }

        }).on('hidden.bs.modal', function(){
            cropper.destroy();
            cropper = null;
        });

        $("#cropImage").on("click", function(){
            let initialPhotoURL,
                canvas;

            $modal.modal("hide");

            if(cropper){
                canvas = cropper.getCroppedCanvas({
                    width: 900,
                    height: 400,
                });

                initialPhotoURL = picture.attr("src");
                picture
                    .attr("src", canvas.toDataURL())
                    .removeClass("d-none");

                canvas.toBlob(function (blob){
                    teamPhoto = blob;
                });
            }
        });

        // Lista de equipos del usuario logueado
        fnListTeam();
    });

    function fnRegisterTeam(){
        let form = $("#frmTeam")[0],
            formData = new FormData(form);

        formData.append("_method", "POST");
        formData.append("imageteam", teamPhoto, "teamPhoto.jpg");

        $.ajax({
            url: '../core/controllers/team.php',
            data: formData,
            type: 'POST',
            dataType: 'json',
            success: function(response){
                alert(response.message);
                $("#addTeamModal").modal("hide");
                $("#frmTeam")[0].reset();

                fnListTeam();
            },
            error: function(xhr, status) {
                alert('There is a problem');
            },
            cache: false,
            contentType: false,
            processData: false
        });
    }

    function fnListTeam(){
        $.ajax({
            url: '../core/controllers/team.php',
            data: { _method: 'GET' },
            type: 'POST',
            dataType: 'json',
            success: function(response){
                if (dataTables != null)
                    dataTables.destroy();

                dataTables = $("#teamList").DataTable({
                    data: response.data,
                    columns:
                    [
                        {
                            data: 'id',
                            title: '#',
                            render: function(data, type, row){
                                return pad(data, 5);
                            }
                        },
                        {
                            data: 'name',
                            title: 'Name'
                        },
                        {
                            data: 'register_date',
                            title: 'Register date'
                        },
                        {
                            data: 'active',
                            title: 'Status',
                            render: function(data, type, row){
                                return (data== 1) ? "Active" : "Disabled";
                            }
                        },
                        {
                            title: '',
                            data: 'active',
                            orderable: false,
                            class: "text-center",
                            render: function ( data, type, row )
                            {
                                return `
                                        <a href="javascript:void(0);" class="mr-2 btn btn-outline-secondary btnEditTeam" title="Edit"><i class="bi bi-pencil"></i></a>
                                        <a href="javascript:void(0);" class="mr-2 btn btn-outline-danger ${(data== 1) ? 'btnDeleteTeam' : 'd-none' }" title="Delete"><i class="bi bi-trash"></i></a>
                                `;
                            }
                        }
                    ]
                });
            },
            error: function(xhr, status) {
                console.log(status);
            }
        });
    }
</script>